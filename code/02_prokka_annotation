# july 12

#go to main folder
mkdir prokka_output
#create folder for prokka output

## prokka loop
for f in ../ncbi_dataset/data/*/*.fna; do
  filename=$(basename "$f")
  filename="${filename/_genomic.fna/}" #to remove _genomic_ at the end of every file/folder name
  name="${filename}"
  prokka_ed -o prokka_${name} --prefix ${name} --locustag ${name} --kingdom Archaea --cpus 32 "$f"; 
done

#The command is correct, but the output takes up a lot of space. Since we are interested in a limited number of genomic features, it is useful to save only certain files. 
#key files 
#.fna = full genome sequence #already present in genomes/
#.ffn = CDS nucleotide sequences
#.faa = protein sequences
#.gff = annotation file
#.tsv = feature table (gene types, lengths, etc.) 

# july 14/15

for f in ../ncbi_dataset/data/*/*.fna; do 
  #clean name
  base_name=$(basename "$fna_file" _genomic.fna);  
  outdir="prokka_${base_name}";
  
  #prokka annotation
  prokka_ed -o "$outdir" --prefix "$name" --locustag "$name" --kingdom Archaea --cpus 32 "$f"; #on a 64 cpu core server

  #remove other files
  find "$outdir" -type f ! \( -name "*.gbk" -o -name "*.gff" -o -name "*.faa" -o -name "*.tsv" \) -delete; 
done

## july 17
#better way to run for downstream gototree

#create mapfile to link genus to acc_id
cut -f1,7 archaea_representatives.tsv > acc_genus.tsv
sed -E 's/^(RS_|GB_)//' acc_genus.tsv > mapfile.tsv

mapfile="../mapfile.tsv"
input="../ncbi_dataset/data/*/*.fna"

for f in $input; do 
  acc=$(basename "$f" _genomic.fna | cut -d'_' -f1,2); 
  genus=$(grep -w "$acc" "$mapfile" | cut -f2); 
  prefix="${genus}_${acc}"; 
  outdir="prokka_${prefix}"; 
  prokka_ed --outdir "$outdir" --prefix "$prefix" --locustag "$prefix" --kingdom Archaea --cpus 32 "$f"; 
  find "$outdir" -type f ! \( -name "*.gbk" -o -name "*.gff" -o -name "*.faa" -o -name "*.tsv" \) -delete; 
done

